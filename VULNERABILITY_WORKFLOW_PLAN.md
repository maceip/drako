# Vulnerability Response Workflow - Implementation Plan

## Overview

Automated system to detect, report, and remediate vulnerabilities in dependencies listed in the SBOM.

---

## Architecture

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Scheduled Scan │────▶│  OSV/NVD Query   │────▶│ Vulnerability   │
│  (daily/weekly) │     │  per dependency  │     │ Database        │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                │
                                ▼
                        ┌──────────────────┐
                        │ Affected Release │
                        │ Discovery        │
                        └──────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
        ┌───────────┐   ┌───────────┐   ┌───────────┐
        │ Patch     │   │ Zero-Day  │   │ No Action │
        │ Available │   │ (no fix)  │   │ Needed    │
        └───────────┘   └───────────┘   └───────────┘
                │               │
                ▼               ▼
        ┌───────────┐   ┌───────────────┐
        │ Auto-bump │   │ Add Warning   │
        │ + Release │   │ Banner        │
        └───────────┘   └───────────────┘
```

---

## Components

### 1. Vulnerability Scanner Workflow

**Trigger:** Schedule (cron) + manual dispatch

**Data Sources:**
- OSV (Open Source Vulnerabilities) - free, covers Maven
- GitHub Advisory Database
- NVD (National Vulnerability Database) - optional

**Process:**
1. Fetch latest SBOM from most recent release
2. Query OSV API for each package:purl
3. Filter by severity (CRITICAL, HIGH)
4. Store findings in JSON artifact

### 2. Release Impact Analyzer

**For each vulnerability found:**
1. Parse all releases via GitHub API
2. Download SBOM from each release
3. Check if vulnerable package:version exists
4. Build list of affected releases

### 3. Response Engine

**Case A: Patch Available**
- Update dependency in build.gradle.kts
- Create PR with security label
- If approved, trigger new release
- Update affected release notes with:
  ```
  SECURITY: CVE-XXXX-XXXXX patched in vX.Y.Z
  ```

**Case B: Zero-Day (No Patch)**
- Add banner to affected releases:
  ```
  WARNING: Unpatched vulnerability CVE-XXXX-XXXXX
  Package: group:artifact:version
  Severity: CRITICAL
  Status: Awaiting upstream fix
  Mitigation: [if available]
  ```
- Open tracking issue
- Subscribe to upstream for updates

---

## Files to Create

```
.github/
├── workflows/
│   ├── vuln-scan.yml          # Scheduled scanner
│   └── vuln-response.yml      # Response automation
├── scripts/
│   ├── scan_sbom.py           # OSV query logic
│   ├── find_affected.py       # Release impact analysis
│   └── update_release.py      # Release note modification
└── SECURITY.md                # Security policy
```

---

## Workflow 1: vuln-scan.yml

```yaml
name: Vulnerability Scan
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      severity:
        type: choice
        options: [CRITICAL, HIGH, MEDIUM]
        default: CRITICAL

jobs:
  scan:
    - Fetch latest SBOM
    - Query OSV API
    - Filter by severity
    - Output: vulnerabilities.json

  assess:
    - Find affected releases
    - Classify response type
    - Output: affected-releases.json

  respond:
    - For patch available: create PR
    - For zero-day: update releases + open issue
```

---

## Workflow 2: vuln-response.yml

```yaml
name: Vulnerability Response
on:
  workflow_call:
    inputs:
      cve_id: string
      package: string
      action: [patch, warn]

jobs:
  patch:
    if: inputs.action == 'patch'
    - Update build.gradle.kts
    - Create PR
    - On merge: trigger release

  warn:
    if: inputs.action == 'warn'
    - For each affected release:
      - Edit release body via API
      - Add warning banner
    - Create tracking issue
```

---

## API Usage

### OSV Query
```bash
POST https://api.osv.dev/v1/querybatch
{
  "queries": [
    {"package": {"purl": "pkg:maven/group/artifact@version"}}
  ]
}
```

### GitHub Release Edit
```bash
PATCH /repos/{owner}/{repo}/releases/{release_id}
{
  "body": "UPDATED BODY WITH WARNING"
}
```

---

## Questions to Clarify

1. **Scan frequency:** Daily? Weekly? On-demand only?
2. **Severity threshold:** CRITICAL only? Include HIGH?
3. **Auto-PR policy:** Require approval or auto-merge for patches?
4. **Notification channel:** GitHub Issues? Slack? Email?
5. **Rollback strategy:** If patched version breaks build?

---

## Implementation Order

1. [ ] Create scan script (scan_sbom.py)
2. [ ] Create vuln-scan.yml with manual trigger
3. [ ] Test with known vulnerability
4. [ ] Add affected release finder
5. [ ] Add release editing capability
6. [ ] Add auto-PR for patches
7. [ ] Add zero-day warning system
8. [ ] Enable scheduled runs

---

## Estimated Effort

| Component | Complexity |
|-----------|------------|
| OSV scanner | Low |
| Affected release finder | Medium |
| Release body updater | Low |
| Auto-patch PR | Medium |
| Zero-day banner | Low |
| Full integration | Medium |

---

## Risks

- **Rate limiting:** GitHub API limits (5000/hr authenticated)
- **False positives:** OSV may report non-applicable vulns
- **Breaking changes:** Auto-bumping may break build
- **Timing:** Zero-day detection depends on OSV ingestion speed

---

## Next Steps

Review this plan and confirm:
1. Proceed with implementation?
2. Any scope changes?
3. Priority order adjustments?
