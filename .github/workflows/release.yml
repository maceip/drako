name: Build, SBOM & Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        run: |
          export ANDROID_HOME="${ANDROID_SDK_ROOT}"
          echo "ANDROID_HOME=${ANDROID_HOME}" >> $GITHUB_ENV

          # Accept all licenses including preview
          mkdir -p "$ANDROID_HOME/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_HOME/licenses/android-sdk-license"
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$ANDROID_HOME/licenses/google-gdk-license"
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$ANDROID_HOME/licenses/mips-android-sysimage-license"

          # Install SDK 36 and NDK 27
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --channel=3 \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "ndk;27.0.12077973"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Generate Gradle Dependency Report
        run: |
          ./gradlew app:dependencies --configuration releaseRuntimeClasspath > dependencies-full.txt 2>&1 || true
          ./gradlew app:dependencies --configuration debugRuntimeClasspath >> dependencies-full.txt 2>&1 || true

      - name: Setup Python for SBOM Analysis
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests matplotlib pandas

      - name: Generate SBOM and Staleness Analysis
        run: |
          cat << 'PYTHON_SCRIPT' > generate_sbom.py
          import json
          import re
          import requests
          from datetime import datetime
          from collections import defaultdict
          import matplotlib.pyplot as plt

          def parse_gradle_dependencies(file_path):
              deps = {}
              with open(file_path, 'r') as f:
                  content = f.read()
              pattern = r'[+\\]--- ([a-zA-Z0-9._-]+):([a-zA-Z0-9._-]+):([0-9a-zA-Z._-]+)'
              matches = re.findall(pattern, content)
              for group, artifact, version in matches:
                  key = f"{group}:{artifact}"
                  if key not in deps:
                      deps[key] = {'group': group, 'artifact': artifact, 'version': version}
              return deps

          def get_maven_metadata(group, artifact):
              group_path = group.replace('.', '/')
              for base_url in [
                  f"https://repo1.maven.org/maven2/{group_path}/{artifact}/maven-metadata.xml",
                  f"https://dl.google.com/dl/android/maven2/{group_path}/{artifact}/maven-metadata.xml"
              ]:
                  try:
                      resp = requests.get(base_url, timeout=10)
                      if resp.status_code == 200:
                          latest = re.search(r'<release>([^<]+)</release>', resp.text)
                          if not latest:
                              latest = re.search(r'<latest>([^<]+)</latest>', resp.text)
                          versions = re.findall(r'<version>([^<]+)</version>', resp.text)
                          return {
                              'latest': latest.group(1) if latest else None,
                              'versions': versions
                          }
                  except Exception:
                      pass
              return None

          def main():
              print("Parsing dependencies...")
              deps = parse_gradle_dependencies('dependencies-full.txt')
              print(f"Found {len(deps)} dependencies")

              sbom = {
                  'bomFormat': 'CycloneDX',
                  'specVersion': '1.4',
                  'version': 1,
                  'metadata': {
                      'timestamp': datetime.utcnow().isoformat() + 'Z',
                      'component': {'type': 'application', 'name': 'drako', 'version': '1.0.0'}
                  },
                  'components': []
              }

              staleness_data = []

              for i, (key, dep) in enumerate(deps.items()):
                  print(f"  [{i+1}/{len(deps)}] {key}")
                  metadata = get_maven_metadata(dep['group'], dep['artifact'])

                  component = {
                      'type': 'library',
                      'group': dep['group'],
                      'name': dep['artifact'],
                      'version': dep['version'],
                      'purl': f"pkg:maven/{dep['group']}/{dep['artifact']}@{dep['version']}"
                  }

                  staleness = {
                      'dependency': key,
                      'current_version': dep['version'],
                      'latest_version': None,
                      'versions_behind': None,
                      'status': 'unknown'
                  }

                  if metadata and metadata.get('latest'):
                      staleness['latest_version'] = metadata['latest']
                      component['latestVersion'] = metadata['latest']

                      if dep['version'] == metadata['latest']:
                          staleness['status'] = 'up-to-date'
                      else:
                          versions = metadata.get('versions', [])
                          try:
                              idx = versions.index(dep['version'])
                              behind = len(versions) - idx - 1
                              staleness['versions_behind'] = behind
                              staleness['status'] = 'up-to-date' if behind == 0 else \
                                  'slightly-outdated' if behind <= 2 else \
                                  'outdated' if behind <= 5 else 'very-outdated'
                          except ValueError:
                              staleness['status'] = 'outdated'

                  sbom['components'].append(component)
                  staleness_data.append(staleness)

              with open('sbom.json', 'w') as f:
                  json.dump(sbom, f, indent=2)

              summary = {
                  'total': len(staleness_data),
                  'up_to_date': sum(1 for s in staleness_data if s['status'] == 'up-to-date'),
                  'slightly_outdated': sum(1 for s in staleness_data if s['status'] == 'slightly-outdated'),
                  'outdated': sum(1 for s in staleness_data if s['status'] == 'outdated'),
                  'very_outdated': sum(1 for s in staleness_data if s['status'] == 'very-outdated'),
                  'unknown': sum(1 for s in staleness_data if s['status'] == 'unknown')
              }

              report = {
                  'generated_at': datetime.utcnow().isoformat() + 'Z',
                  'summary': summary,
                  'dependencies': sorted(staleness_data, key=lambda x: -(x['versions_behind'] or 0))
              }
              with open('staleness-report.json', 'w') as f:
                  json.dump(report, f, indent=2)

              # Generate graph
              fig, axes = plt.subplots(2, 2, figsize=(14, 10))
              fig.suptitle('Dependency Update Cadence Analysis', fontsize=14, fontweight='bold')

              # Pie chart
              ax1 = axes[0, 0]
              labels = ['Up to Date', 'Slightly Outdated', 'Outdated', 'Very Outdated', 'Unknown']
              sizes = [summary['up_to_date'], summary['slightly_outdated'], summary['outdated'],
                       summary['very_outdated'], summary['unknown']]
              colors = ['#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6']
              non_zero = [(l,s,c) for l,s,c in zip(labels, sizes, colors) if s > 0]
              if non_zero:
                  l, s, c = zip(*non_zero)
                  ax1.pie(s, labels=l, colors=c, autopct='%1.1f%%')
              ax1.set_title('Dependency Status Distribution')

              # Histogram
              ax2 = axes[0, 1]
              behind = [s['versions_behind'] for s in staleness_data if s['versions_behind']]
              if behind:
                  ax2.hist(behind, bins=min(20, max(behind)+1), color='#3498db', edgecolor='black')
                  ax2.set_xlabel('Versions Behind')
                  ax2.set_ylabel('Count')
              ax2.set_title('Version Lag Distribution')

              # Top outdated
              ax3 = axes[1, 0]
              outdated = sorted([s for s in staleness_data if s['versions_behind'] and s['versions_behind'] > 0],
                               key=lambda x: -x['versions_behind'])[:10]
              if outdated:
                  names = [d['dependency'].split(':')[1][:20] for d in outdated]
                  vals = [d['versions_behind'] for d in outdated]
                  ax3.barh(names, vals, color='#e74c3c')
                  ax3.set_xlabel('Versions Behind')
                  ax3.invert_yaxis()
              ax3.set_title('Top 10 Outdated Dependencies')

              # By group
              ax4 = axes[1, 1]
              groups = defaultdict(list)
              for s in staleness_data:
                  if s['versions_behind'] is not None:
                      g = '.'.join(s['dependency'].split(':')[0].split('.')[:2])
                      groups[g].append(s['versions_behind'])
              if groups:
                  avg = {k: sum(v)/len(v) for k,v in groups.items()}
                  top = sorted(avg.items(), key=lambda x: -x[1])[:10]
                  if top:
                      g, v = zip(*top)
                      ax4.barh([x[:15] for x in g], v, color='#9b59b6')
                      ax4.set_xlabel('Avg Versions Behind')
                      ax4.invert_yaxis()
              ax4.set_title('Update Cadence by Group')

              plt.tight_layout()
              plt.savefig('update-cadence-graph.png', dpi=150)

              # Markdown summary
              with open('sbom-summary.md', 'w') as f:
                  f.write(f'# SBOM Summary\n\nGenerated: {datetime.utcnow():%Y-%m-%d %H:%M UTC}\n\n')
                  f.write(f'| Status | Count |\n|--------|-------|\n')
                  f.write(f'| Total | {summary["total"]} |\n')
                  f.write(f'| Up to Date | {summary["up_to_date"]} |\n')
                  f.write(f'| Slightly Outdated | {summary["slightly_outdated"]} |\n')
                  f.write(f'| Outdated | {summary["outdated"]} |\n')
                  f.write(f'| Very Outdated | {summary["very_outdated"]} |\n\n')
                  f.write('![Graph](update-cadence-graph.png)\n')

              print("Done!")

          if __name__ == '__main__':
              main()
          PYTHON_SCRIPT
          python generate_sbom.py

      - name: Get next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          if [ $PATCH -ge 100 ]; then PATCH=0; MINOR=$((MINOR + 1)); fi
          if [ $MINOR -ge 100 ]; then MINOR=0; MAJOR=$((MAJOR + 1)); fi
          echo "new_version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME="drako-${{ steps.version.outputs.new_version }}-debug.apk"
          cp "$APK_PATH" "$APK_NAME"
          echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            ${{ steps.find_apk.outputs.apk_path }}
            sbom.json

      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom.json
            staleness-report.json
            sbom-summary.md
            update-cadence-graph.png

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ steps.find_apk.outputs.apk_path }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body: |
            ## Drako ${{ steps.version.outputs.new_version }}

            **Build:** ${{ github.sha }}
            **Date:** ${{ github.event.head_commit.timestamp }}

            ### Artifacts
            - Debug APK
            - SBOM with dependency staleness analysis
            - Update cadence visualization

            ---
            *Automated release*
          files: |
            ${{ steps.find_apk.outputs.apk_path }}
            sbom.json
            staleness-report.json
            sbom-summary.md
            update-cadence-graph.png
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:** APK, SBOM, Staleness Report, Update Graph" >> $GITHUB_STEP_SUMMARY
