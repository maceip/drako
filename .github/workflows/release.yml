name: Build, SBOM & Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        run: |
          export ANDROID_HOME="${ANDROID_SDK_ROOT}"
          echo "ANDROID_HOME=${ANDROID_HOME}" >> $GITHUB_ENV

          # Accept all licenses including preview
          mkdir -p "$ANDROID_HOME/licenses"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_HOME/licenses/android-sdk-license"
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$ANDROID_HOME/licenses/google-gdk-license"
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$ANDROID_HOME/licenses/mips-android-sysimage-license"

          # Install SDK 36 and NDK 27
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --channel=3 \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "ndk;27.0.12077973"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Generate Gradle Dependency Report
        run: |
          ./gradlew app:dependencies --configuration releaseRuntimeClasspath > dependencies-full.txt 2>&1 || true
          ./gradlew app:dependencies --configuration debugRuntimeClasspath >> dependencies-full.txt 2>&1 || true

      - name: Setup Python for SBOM Analysis
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests matplotlib pandas seaborn

      - name: Generate SBOM and Staleness Analysis
        run: |
          cat << 'PYTHON_SCRIPT' > generate_sbom.py
          import json
          import re
          import requests
          from datetime import datetime
          from collections import defaultdict
          import matplotlib.pyplot as plt
          import matplotlib.patches as mpatches
          import numpy as np

          # Modern dark theme
          plt.style.use('dark_background')
          COLORS = {
              'bg': '#0d1117',
              'card': '#161b22',
              'border': '#30363d',
              'text': '#c9d1d9',
              'green': '#3fb950',
              'yellow': '#d29922',
              'orange': '#db6d28',
              'red': '#f85149',
              'gray': '#484f58',
              'purple': '#a371f7',
              'blue': '#58a6ff'
          }

          def parse_gradle_dependencies(file_path):
              deps = {}
              with open(file_path, 'r') as f:
                  content = f.read()
              pattern = r'[+\\]--- ([a-zA-Z0-9._-]+):([a-zA-Z0-9._-]+):([0-9a-zA-Z._-]+)'
              for group, artifact, version in re.findall(pattern, content):
                  key = f"{group}:{artifact}"
                  if key not in deps:
                      deps[key] = {'group': group, 'artifact': artifact, 'version': version}
              return deps

          def get_maven_metadata(group, artifact):
              group_path = group.replace('.', '/')
              for url in [
                  f"https://repo1.maven.org/maven2/{group_path}/{artifact}/maven-metadata.xml",
                  f"https://dl.google.com/dl/android/maven2/{group_path}/{artifact}/maven-metadata.xml"
              ]:
                  try:
                      resp = requests.get(url, timeout=10)
                      if resp.status_code == 200:
                          latest = re.search(r'<release>([^<]+)</release>', resp.text)
                          if not latest:
                              latest = re.search(r'<latest>([^<]+)</latest>', resp.text)
                          return {
                              'latest': latest.group(1) if latest else None,
                              'versions': re.findall(r'<version>([^<]+)</version>', resp.text)
                          }
                  except:
                      pass
              return None

          def main():
              print("Parsing dependencies...")
              deps = parse_gradle_dependencies('dependencies-full.txt')
              print(f"Found {len(deps)} dependencies")

              sbom = {
                  'bomFormat': 'CycloneDX', 'specVersion': '1.4', 'version': 1,
                  'metadata': {
                      'timestamp': datetime.utcnow().isoformat() + 'Z',
                      'component': {'type': 'application', 'name': 'drako', 'version': '1.0.0'}
                  },
                  'components': []
              }
              staleness_data = []

              for i, (key, dep) in enumerate(deps.items()):
                  print(f"  [{i+1}/{len(deps)}] {key}")
                  metadata = get_maven_metadata(dep['group'], dep['artifact'])

                  component = {
                      'type': 'library', 'group': dep['group'], 'name': dep['artifact'],
                      'version': dep['version'],
                      'purl': f"pkg:maven/{dep['group']}/{dep['artifact']}@{dep['version']}"
                  }
                  staleness = {
                      'dependency': key, 'current_version': dep['version'],
                      'latest_version': None, 'versions_behind': None, 'status': 'unknown'
                  }

                  if metadata and metadata.get('latest'):
                      staleness['latest_version'] = metadata['latest']
                      component['latestVersion'] = metadata['latest']
                      if dep['version'] == metadata['latest']:
                          staleness['status'] = 'up-to-date'
                      else:
                          versions = metadata.get('versions', [])
                          try:
                              behind = len(versions) - versions.index(dep['version']) - 1
                              staleness['versions_behind'] = behind
                              staleness['status'] = 'up-to-date' if behind == 0 else \
                                  'slightly-outdated' if behind <= 2 else \
                                  'outdated' if behind <= 5 else 'very-outdated'
                          except ValueError:
                              staleness['status'] = 'outdated'

                  sbom['components'].append(component)
                  staleness_data.append(staleness)

              with open('sbom.json', 'w') as f:
                  json.dump(sbom, f, indent=2)

              summary = {
                  'total': len(staleness_data),
                  'up_to_date': sum(1 for s in staleness_data if s['status'] == 'up-to-date'),
                  'slightly_outdated': sum(1 for s in staleness_data if s['status'] == 'slightly-outdated'),
                  'outdated': sum(1 for s in staleness_data if s['status'] == 'outdated'),
                  'very_outdated': sum(1 for s in staleness_data if s['status'] == 'very-outdated'),
                  'unknown': sum(1 for s in staleness_data if s['status'] == 'unknown')
              }

              report = {
                  'generated_at': datetime.utcnow().isoformat() + 'Z',
                  'summary': summary,
                  'dependencies': sorted(staleness_data, key=lambda x: -(x['versions_behind'] or 0))
              }
              with open('staleness-report.json', 'w') as f:
                  json.dump(report, f, indent=2)

              # Modern dark theme graph
              fig = plt.figure(figsize=(16, 10), facecolor=COLORS['bg'])
              fig.suptitle('üì¶ Dependency Staleness Report', fontsize=20, fontweight='bold',
                          color=COLORS['text'], y=0.98)

              # Grid layout
              gs = fig.add_gridspec(2, 3, hspace=0.3, wspace=0.3,
                                   left=0.06, right=0.94, top=0.9, bottom=0.08)

              # 1. Donut chart - Status Distribution
              ax1 = fig.add_subplot(gs[0, 0])
              ax1.set_facecolor(COLORS['bg'])
              labels = ['Up to Date', 'Slightly Outdated', 'Outdated', 'Very Outdated', 'Unknown']
              sizes = [summary['up_to_date'], summary['slightly_outdated'], summary['outdated'],
                      summary['very_outdated'], summary['unknown']]
              colors = [COLORS['green'], COLORS['yellow'], COLORS['orange'], COLORS['red'], COLORS['gray']]
              non_zero = [(l,s,c) for l,s,c in zip(labels, sizes, colors) if s > 0]
              if non_zero:
                  l, s, c = zip(*non_zero)
                  wedges, texts, autotexts = ax1.pie(s, colors=c, autopct='%1.0f%%',
                      startangle=90, pctdistance=0.75,
                      wedgeprops=dict(width=0.5, edgecolor=COLORS['bg'], linewidth=2))
                  for t in autotexts:
                      t.set_color('white')
                      t.set_fontweight('bold')
                      t.set_fontsize(10)
                  ax1.legend(wedges, l, loc='center', fontsize=8,
                            frameon=False, labelcolor=COLORS['text'])
              ax1.set_title('Status Distribution', color=COLORS['text'], fontsize=12, pad=10)

              # 2. Summary stats card
              ax2 = fig.add_subplot(gs[0, 1])
              ax2.set_facecolor(COLORS['card'])
              ax2.set_xlim(0, 10)
              ax2.set_ylim(0, 10)
              ax2.axis('off')

              stats_text = f"""
              üìä SUMMARY

              Total Dependencies: {summary['total']}

              ‚úÖ Up to Date: {summary['up_to_date']}
              ‚ö†Ô∏è  Slightly Outdated: {summary['slightly_outdated']}
              üî∂ Outdated: {summary['outdated']}
              üî¥ Very Outdated: {summary['very_outdated']}
              ‚ùì Unknown: {summary['unknown']}
              """
              ax2.text(0.5, 0.5, stats_text, transform=ax2.transAxes, fontsize=11,
                      color=COLORS['text'], verticalalignment='center',
                      fontfamily='monospace', linespacing=1.8)
              rect = mpatches.FancyBboxPatch((0.02, 0.02), 9.96, 9.96,
                  boxstyle="round,pad=0.02,rounding_size=0.5",
                  facecolor=COLORS['card'], edgecolor=COLORS['border'], linewidth=2)
              ax2.add_patch(rect)

              # 3. Version lag histogram
              ax3 = fig.add_subplot(gs[0, 2])
              ax3.set_facecolor(COLORS['card'])
              behind = [s['versions_behind'] for s in staleness_data if s['versions_behind'] and s['versions_behind'] > 0]
              if behind:
                  bins = range(0, max(behind) + 2)
                  ax3.hist(behind, bins=bins, color=COLORS['blue'], edgecolor=COLORS['bg'],
                          linewidth=1, alpha=0.8, rwidth=0.85)
                  ax3.set_xlabel('Versions Behind', color=COLORS['text'], fontsize=10)
                  ax3.set_ylabel('Count', color=COLORS['text'], fontsize=10)
              ax3.set_title('Version Lag Distribution', color=COLORS['text'], fontsize=12, pad=10)
              ax3.tick_params(colors=COLORS['text'])
              for spine in ax3.spines.values():
                  spine.set_color(COLORS['border'])

              # 4. Top outdated (horizontal bar)
              ax4 = fig.add_subplot(gs[1, :2])
              ax4.set_facecolor(COLORS['card'])
              outdated = sorted([s for s in staleness_data if s['versions_behind'] and s['versions_behind'] > 0],
                              key=lambda x: -x['versions_behind'])[:12]
              if outdated:
                  names = [d['dependency'].split(':')[1][:25] for d in outdated]
                  vals = [d['versions_behind'] for d in outdated]
                  colors_bar = [COLORS['red'] if v > 10 else COLORS['orange'] if v > 5 else COLORS['yellow'] for v in vals]
                  bars = ax4.barh(names, vals, color=colors_bar, edgecolor=COLORS['bg'], height=0.7)
                  ax4.set_xlabel('Versions Behind Latest', color=COLORS['text'], fontsize=10)
                  ax4.invert_yaxis()
                  for bar, val in zip(bars, vals):
                      ax4.text(val + 0.3, bar.get_y() + bar.get_height()/2, str(val),
                              va='center', color=COLORS['text'], fontsize=9)
              ax4.set_title('üî• Most Outdated Dependencies', color=COLORS['text'], fontsize=12, pad=10)
              ax4.tick_params(colors=COLORS['text'])
              for spine in ax4.spines.values():
                  spine.set_color(COLORS['border'])

              # 5. By ecosystem
              ax5 = fig.add_subplot(gs[1, 2])
              ax5.set_facecolor(COLORS['card'])
              groups = defaultdict(list)
              for s in staleness_data:
                  if s['versions_behind'] is not None:
                      g = '.'.join(s['dependency'].split(':')[0].split('.')[:2])
                      groups[g].append(s['versions_behind'])
              if groups:
                  avg = {k: sum(v)/len(v) for k,v in groups.items()}
                  top = sorted(avg.items(), key=lambda x: -x[1])[:8]
                  if top:
                      g, v = zip(*top)
                      g = [x.replace('androidx.', '').replace('org.', '')[:12] for x in g]
                      ax5.barh(g, v, color=COLORS['purple'], edgecolor=COLORS['bg'], height=0.6)
                      ax5.invert_yaxis()
                      ax5.set_xlabel('Avg Versions Behind', color=COLORS['text'], fontsize=10)
              ax5.set_title('By Ecosystem', color=COLORS['text'], fontsize=12, pad=10)
              ax5.tick_params(colors=COLORS['text'])
              for spine in ax5.spines.values():
                  spine.set_color(COLORS['border'])

              plt.savefig('update-cadence-graph.png', dpi=150, facecolor=COLORS['bg'],
                         edgecolor='none', bbox_inches='tight')
              print("Graph saved!")

              # Markdown summary with emoji status
              health_score = int((summary['up_to_date'] / max(summary['total'], 1)) * 100)
              health_emoji = "üü¢" if health_score >= 80 else "üü°" if health_score >= 50 else "üî¥"

              with open('sbom-summary.md', 'w') as f:
                  f.write(f'# üì¶ SBOM Health Report\n\n')
                  f.write(f'**Health Score:** {health_emoji} {health_score}%\n\n')
                  f.write(f'| Status | Count | % |\n|--------|-------|---|\n')
                  for status, count, emoji in [
                      ('Up to Date', summary['up_to_date'], '‚úÖ'),
                      ('Slightly Outdated', summary['slightly_outdated'], '‚ö†Ô∏è'),
                      ('Outdated', summary['outdated'], 'üî∂'),
                      ('Very Outdated', summary['very_outdated'], 'üî¥'),
                      ('Unknown', summary['unknown'], '‚ùì')
                  ]:
                      pct = int(count / max(summary['total'], 1) * 100)
                      f.write(f'| {emoji} {status} | {count} | {pct}% |\n')
                  f.write(f'\n**Total Dependencies:** {summary["total"]}\n')

              print("Done!")

          if __name__ == '__main__':
              main()
          PYTHON_SCRIPT
          python generate_sbom.py

      - name: Get next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          if [ $PATCH -ge 100 ]; then PATCH=0; MINOR=$((MINOR + 1)); fi
          if [ $MINOR -ge 100 ]; then MINOR=0; MAJOR=$((MAJOR + 1)); fi
          echo "new_version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          APK_NAME="drako-${{ steps.version.outputs.new_version }}-debug.apk"
          cp "$APK_PATH" "$APK_NAME"
          echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Generate artifact attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            ${{ steps.find_apk.outputs.apk_path }}
            sbom.json
            staleness-report.json
            update-cadence-graph.png

      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom.json
            staleness-report.json
            sbom-summary.md
            update-cadence-graph.png

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ steps.find_apk.outputs.apk_path }}

      - name: Generate release body
        id: release_body
        run: |
          # Read staleness summary
          HEALTH=$(python3 -c "import json; d=json.load(open('staleness-report.json')); s=d['summary']; print(int(s['up_to_date']/max(s['total'],1)*100))")
          TOTAL=$(python3 -c "import json; print(json.load(open('staleness-report.json'))['summary']['total'])")
          UP_TO_DATE=$(python3 -c "import json; print(json.load(open('staleness-report.json'))['summary']['up_to_date'])")
          OUTDATED=$(python3 -c "import json; s=json.load(open('staleness-report.json'))['summary']; print(s['outdated']+s['very_outdated'])")

          if [ "$HEALTH" -ge 80 ]; then EMOJI="üü¢"; elif [ "$HEALTH" -ge 50 ]; then EMOJI="üü°"; else EMOJI="üî¥"; fi

          cat << EOF > release-body.md
          ## üêâ Drako ${{ steps.version.outputs.new_version }}

          | | |
          |---|---|
          | **Commit** | \`${{ github.sha }}\` |
          | **Date** | $(date -u +"%Y-%m-%d %H:%M UTC") |

          ---

          ### üì¶ Dependency Health Report

          **Health Score:** ${EMOJI} **${HEALTH}%**

          | Metric | Value |
          |--------|-------|
          | Total Dependencies | ${TOTAL} |
          | ‚úÖ Up to Date | ${UP_TO_DATE} |
          | ‚ö†Ô∏è Need Updates | ${OUTDATED} |

          <details>
          <summary>üìä Staleness Visualization</summary>

          ![Dependency Staleness Report](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.new_version }}/update-cadence-graph.png)

          </details>

          ---

          ### üì• Downloads
          - **APK:** \`drako-${{ steps.version.outputs.new_version }}-debug.apk\`
          - **SBOM:** \`sbom.json\` (CycloneDX format)
          - **Full Report:** \`staleness-report.json\`

          ---
          *Automated release by GitHub Actions* ü§ñ
          EOF

          echo "body_file=release-body.md" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body_path: release-body.md
          files: |
            ${{ steps.find_apk.outputs.apk_path }}
            sbom.json
            staleness-report.json
            sbom-summary.md
            update-cadence-graph.png
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:** APK, SBOM, Staleness Report, Update Graph" >> $GITHUB_STEP_SUMMARY
